CREATE OR REPLACE PROCEDURE cleanInstance
AS
BEGIN
	INSERT INTO TEMP_CLEANUP (ID) SELECT ID FROM ODE_PROCESS_INSTANCE WHERE INSTANCE_STATE = 30 AND LAST_ACTIVE_TIME < SYSTIMESTAMP; 
	DELETE FROM ODE_EVENT WHERE INSTANCE_ID IN (SELECT ID FROM TEMP_CLEANUP);
	DELETE FROM ODE_CORSET_PROP WHERE CORRSET_ID IN (SELECT CS.CORRELATION_SET_ID FROM ODE_CORRELATION_SET CS WHERE CS.SCOPE_ID IN (SELECT OS.SCOPE_ID FROM ODE_SCOPE OS WHERE	 OS.PROCESS_INSTANCE_ID IN (SELECT ID FROM TEMP_CLEANUP)));
	DELETE FROM ODE_CORRELATION_SET WHERE SCOPE_ID IN (SELECT OS.SCOPE_ID FROM ODE_SCOPE OS WHERE OS.PROCESS_INSTANCE_ID IN (SELECT ID FROM TEMP_CLEANUP));
	DELETE FROM ODE_PARTNER_LINK WHERE SCOPE_ID IN (SELECT OS.SCOPE_ID FROM ODE_SCOPE OS WHERE OS.PROCESS_INSTANCE_ID IN (SELECT ID FROM TEMP_CLEANUP));
	DELETE FROM ODE_XML_DATA_PROP WHERE XML_DATA_ID IN (SELECT XD.XML_DATA_ID FROM ODE_XML_DATA XD WHERE XD.SCOPE_ID IN (SELECT OS.SCOPE_ID FROM ODE_SCOPE OS WHERE OS.PROCESS_INSTANCE_ID IN (SELECT ID FROM TEMP_CLEANUP)));
	DELETE FROM ODE_XML_DATA WHERE SCOPE_ID IN (SELECT OS.SCOPE_ID FROM ODE_SCOPE OS WHERE OS.PROCESS_INSTANCE_ID IN (SELECT ID FROM TEMP_CLEANUP));
	DELETE FROM ODE_SCOPE WHERE PROCESS_INSTANCE_ID IN (SELECT ID FROM TEMP_CLEANUP);
	DELETE FROM ODE_MEX_PROP WHERE MEX_ID IN (SELECT MEX.MESSAGE_EXCHANGE_ID FROM ODE_MESSAGE_EXCHANGE MEX WHERE MEX.PROCESS_INSTANCE_ID IN (SELECT ID FROM TEMP_CLEANUP));
	DELETE FROM ODE_MESSAGE WHERE MESSAGE_EXCHANGE_ID IN (SELECT MEX.MESSAGE_EXCHANGE_ID FROM ODE_MESSAGE_EXCHANGE MEX WHERE MEX.PROCESS_INSTANCE_ID IN (SELECT ID FROM TEMP_CLEANUP));
	DELETE FROM ODE_MESSAGE_EXCHANGE WHERE PROCESS_INSTANCE_ID IN (SELECT ID FROM TEMP_CLEANUP);
	DELETE FROM ODE_MESSAGE_ROUTE WHERE PROCESS_INSTANCE_ID IN (SELECT ID FROM TEMP_CLEANUP);
	DELETE FROM ODE_PROCESS_INSTANCE WHERE ID IN (SELECT ID FROM TEMP_CLEANUP);
	DELETE FROM TEMP_CLEANUP;
	COMMIT;
END;
/
CREATE OR REPLACE
PROCEDURE cleanTaskInstance
AS 
BEGIN
  INSERT INTO TEMP_CLEANUP (ID) SELECT ID FROM HT_TASK WHERE STATUS ='COMPLETED';
  DELETE FROM HT_DEADLINE WHERE TASK_ID IN (SELECT ID FROM TEMP_CLEANUP);
  DELETE FROM HT_EVENT WHERE HT_EVENT.TASK_ID IN (SELECT ID FROM TEMP_CLEANUP);
  DELETE FROM HT_ORG_ENTITY WHERE ORG_ENTITY_ID IN ( SELECT ORGENTITY_ID FROM HT_HUMANROLE_ORGENTITY WHERE HUMANROLE_ID IN ( SELECT GHR_ID FROM HT_GENERIC_HUMAN_ROLE WHERE TASK_ID IN ( SELECT ID FROM TEMP_CLEANUP)));
  DELETE FROM HT_HUMANROLE_ORGENTITY WHERE HUMANROLE_ID IN ( SELECT GHR_ID FROM HT_GENERIC_HUMAN_ROLE WHERE TASK_ID IN ( SELECT ID FROM TEMP_CLEANUP));
  DELETE FROM HT_GENERIC_HUMAN_ROLE WHERE TASK_ID IN(SELECT ID FROM TEMP_CLEANUP);
  DELETE FROM HT_PRESENTATION_ELEMENT WHERE TASK_ID IN (SELECT ID FROM TEMP_CLEANUP);
  DELETE FROM HT_PRESENTATION_PARAM WHERE TASK_ID IN (SELECT ID FROM TEMP_CLEANUP);
  DELETE FROM HT_MESSAGE WHERE TASK_ID IN (SELECT ID FROM TEMP_CLEANUP);
  DELETE FROM HT_TASK_COMMENT WHERE TASK_ID IN(SELECT ID FROM TEMP_CLEANUP);
  DELETE FROM HT_TASK WHERE ID IN(SELECT ID FROM TEMP_CLEANUP);
  DELETE FROM TEMP_CLEANUP;
END;
/



